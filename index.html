<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Araç Envanteri Yönetimi</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter fontu ve temel arkaplan stilini uygula */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        /* Masaüstü görünümünde form ve listenin yan yana olması için stil */
        @media (min-width: 1024px) {
            .main-layout:not(.has-hidden-form) {
                grid-template-columns: 1fr 2fr; 
            }
            .main-layout.has-hidden-form {
                grid-template-columns: 1fr; 
            }
        }
        .table-cell {
            vertical-align: middle;
        }
        .input-focus:focus {
            --tw-ring-color: #3b82f6; 
        }
        @media (min-width: 1024px) {
            .lg-sticky-top {
                top: 2.5rem; 
            }
        }
    </style>
</head>
<body class="p-4 lg:p-10">

    <script>
        // Sabitler
        const VEHICLES_KEY = 'corporate_vehicles_inventory'; 
        
        // ************************************************************
        // UI Elementlerini Yükleme ve Global Değişkenler
        // ************************************************************
        let vehicleForm, vehicleListBody, loadingIndicator, searchInput,
            mainLayout, toggleFormButton, formSection, plusIcon, minusIcon,
            singleEntryTabBtn, bulkImportTabBtn, singleEntryArea, bulkImportArea,
            bulkDataInput, bulkImportButton, bulkFileInput, totalCountDisplay,
            deleteAllButton, formTitle, submitButton, cancelButton,
            exportDataButton; 
            
        let vehiclesData = []; 
        let currentEditingId = null; 

        // Elementleri DOM'dan çekme fonksiyonu
        function getElements() {
            vehicleForm = document.getElementById('vehicleForm');
            vehicleListBody = document.getElementById('vehicleListBody');
            loadingIndicator = document.getElementById('loadingIndicator');
            searchInput = document.getElementById('searchInput');
            mainLayout = document.getElementById('mainLayout');
            toggleFormButton = document.getElementById('toggleFormButton');
            formSection = document.getElementById('formSection');
            plusIcon = document.getElementById('plusIcon');
            minusIcon = document.getElementById('minusIcon');
            singleEntryTabBtn = document.getElementById('singleEntryTabBtn');
            bulkImportTabBtn = document.getElementById('bulkImportTabBtn');
            singleEntryArea = document.getElementById('singleEntryArea');
            bulkImportArea = document.getElementById('bulkImportArea');
            bulkDataInput = document.getElementById('bulkDataInput');
            bulkImportButton = document.getElementById('bulkImportButton');
            bulkFileInput = document.getElementById('bulkFileInput');
            totalCountDisplay = document.getElementById('totalCountDisplay'); 
            deleteAllButton = document.getElementById('deleteAllButton'); 
            formTitle = document.getElementById('formTitle'); 
            submitButton = document.getElementById('submitButton'); 
            cancelButton = document.getElementById('cancelButton');
            exportDataButton = document.getElementById('exportDataButton'); 
        }

        /**
         * Bildirim Gösterme Fonksiyonu
         */
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            if (!container) return; 

            const color = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-gray-500'));

            const notification = document.createElement('div');
            notification.className = `${color} text-white px-4 py-3 rounded-xl shadow-lg mb-2 opacity-0 transform transition-all duration-300 translate-y-4 max-w-sm`;
            notification.innerHTML = `<p class="font-bold">${type === 'success' ? 'Başarılı' : (type === 'error' ? 'Hata' : 'Bilgi')}:</p><div class="text-sm mt-1">${message}</div>`;

            container.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-y-4');
            }, 10);

            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-4');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 6000); 
        }

        // 1. Yerel Depolamadan Verileri Yükle
        function loadVehicles() {
            try {
                const storedVehicles = localStorage.getItem(VEHICLES_KEY);
                vehiclesData = storedVehicles ? JSON.parse(storedVehicles) : [];
            } catch (error) {
                console.error("Yerel depolamadan yüklenirken hata oluştu:", error);
                showNotification("Veriler yüklenemedi. Tarayıcınızda 'localStorage' devre dışı olabilir.", 'error');
                vehiclesData = [];
            }
            
            vehiclesData.sort((a, b) => b.createdAt - a.createdAt);
            filterAndRenderVehicles(); 
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
        }

        // 2. Verileri Yerel Depolamaya Kaydet
        function saveVehicles() {
            try {
                localStorage.setItem(VEHICLES_KEY, JSON.stringify(vehiclesData));
            } catch (error) {
                console.error("Yerel depolamaya kaydederken hata oluştu:", error);
                showNotification("Veriler yerel depolamaya kaydedilemedi.", 'error');
            }
        }
        
        // Tüm Listeyi Silme Fonksiyonu
        function deleteAllVehicles() {
            if (vehiclesData.length === 0) {
                showNotification("Silinecek araç kaydı bulunmamaktadır.", 'error');
                return;
            }

            const confirmation = window.confirm("UYARI! Bu işlem geri alınamaz. Kayıtlı tüm araçları silmek istediğinizden emin misiniz?");
            
            if (confirmation) {
                vehiclesData = []; 
                localStorage.removeItem(VEHICLES_KEY); 
                filterAndRenderVehicles();
                showNotification("Tüm araç kayıtları başarıyla silindi. Envanter sıfırlandı.", 'success');
                hideForm(); 
            } else {
                showNotification("Silme işlemi iptal edildi.", 'info');
            }
        }
        
        // Veri Dışa Aktarma (Export)
        function exportData(format) {
            if (vehiclesData.length === 0) {
                showNotification("Dışa aktarılacak veri bulunmamaktadır.", 'error');
                return;
            }

            let data, filename, mimeType;
            
            // CSV için başlık satırı (Tüm alanlar: 5 manuel + 2 otomatik)
            const headers = ["model", "plate", "driver", "unit", "policyEnd", "createdAt", "id"];
            const headerRow = headers.join(',');

            if (format === 'csv') {
                const csvRows = vehiclesData.map(vehicle => 
                    headers.map(fieldName => {
                        // Virgüllü veriler için tırnak işareti ekle
                        const value = vehicle[fieldName] ? vehicle[fieldName].toString().replace(/"/g, '""') : '';
                        return `"${value}"`; 
                    }).join(',')
                );
                
                // İlk satır başlıklar, gerisi veriler.
                data = headerRow + '\n' + csvRows.join('\n');
                filename = `arac_envanter_yedek_${new Date().toISOString().slice(0, 10)}.csv`;
                mimeType = 'text/csv';
            } else if (format === 'json') {
                data = JSON.stringify(vehiclesData, null, 2); 
                filename = `arac_envanter_yedek_${new Date().toISOString().slice(0, 10)}.json`;
                mimeType = 'application/json';
            } else {
                showNotification("Geçersiz dışa aktarma formatı.", 'error');
                return;
            }

            // İndirme işlemini başlat
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); 

            showNotification(`${format.toUpperCase()} yedeği başarıyla indirildi.`, 'success');
        }


        // Poliçe Bitişinin Yakın Olup Olmadığını Kontrol Et (90 günden az kaldıysa)
        function isPolicyExpiringSoon(policyDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            if (isNaN(policyDate.getTime())) return false; 
            
            const diffTime = policyDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays > 0 && diffDays <= 90; 
        }
        
        // Toplam Sayıyı Güncelleme Fonksiyonu
        function updateTotalCount(totalCount, filteredCount) {
            if (!totalCountDisplay) return;

            if (totalCount === filteredCount) {
                // Sadece toplamı rozet içinde göster
                totalCountDisplay.innerHTML = `<span class="px-2 py-1 rounded-full bg-indigo-500 text-white font-bold text-base shadow-lg">${totalCount}</span>`;
            } else {
                // Filtreleme yapılmışsa, filtrelenen/toplamı rozet içinde göster
                 totalCountDisplay.innerHTML = `<span class="px-2 py-1 rounded-full bg-gray-600 text-white font-bold text-base shadow-lg">${filteredCount} / ${totalCount}</span>`;
            }
        }

        // Araç Düzenleme Modunu Başlatma
        function editVehicle(id) {
            const vehicleToEdit = vehiclesData.find(v => v.id === id);
            if (!vehicleToEdit) {
                showNotification("Düzenlenecek araç bulunamadı.", 'error');
                return;
            }

            currentEditingId = id;
            showForm(); 
            switchTab('single'); 

            document.getElementById('model').value = vehicleToEdit.model;
            document.getElementById('plate').value = vehicleToEdit.plate;
            document.getElementById('driver').value = vehicleToEdit.driver;
            document.getElementById('unit').value = vehicleToEdit.unit;
            document.getElementById('policyEnd').value = vehicleToEdit.policyEnd; 

            formTitle.textContent = "Araç Bilgilerini Düzenle";
            submitButton.textContent = "Güncellemeyi Kaydet";
            submitButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            submitButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
            cancelButton.classList.remove('hidden'); 
            
            showNotification(`'${vehicleToEdit.model}' için düzenleme modu aktif.`, 'info');
        }
        
        // Düzenleme Modundan Çıkma
        function exitEditMode() {
            currentEditingId = null;
            vehicleForm.reset();
            
            formTitle.textContent = "Yeni Araç Kaydı";
            submitButton.textContent = "Aracı Envantere Kaydet";
            submitButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            submitButton.classList.add('bg-green-500', 'hover:bg-green-600');
            cancelButton.classList.add('hidden');
        }

        // Araç Listesini HTML'e Çizme Fonksiyonu
        function renderVehicles(vehicles) {
            if (!vehicleListBody) return;
            vehicleListBody.innerHTML = ''; 
            
            updateTotalCount(vehiclesData.length, vehicles.length);
            
            if (deleteAllButton) {
                 if (vehiclesData.length > 0) {
                    deleteAllButton.classList.remove('hidden');
                    exportDataButton.classList.remove('hidden'); // Export butonunu göster
                } else {
                    deleteAllButton.classList.add('hidden');
                    exportDataButton.classList.add('hidden'); // Export butonunu gizle
                }
            }


            if (vehicles.length === 0) {
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                const message = searchTerm 
                    ? `"${searchTerm}" ile eşleşen araç bulunamadı.` 
                    : `Henüz kayıtlı araç bulunmamaktadır.`;
                vehicleListBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-4 text-center text-gray-400 italic">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }

            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 hover:bg-blue-50/50 transition duration-200';

                const policyDateValue = new Date(vehicle.policyEnd); 
                const formattedDate = isNaN(policyDateValue) ? 'Tarih Yok' : policyDateValue.toLocaleDateString('tr-TR', { year: 'numeric', month: 'short', day: 'numeric' });
                
                const expiringSoon = isPolicyExpiringSoon(policyDateValue);
                const badgeClasses = expiringSoon 
                    ? 'bg-red-500 text-white shadow-md font-extrabold' 
                    : 'bg-green-100 text-green-700 font-semibold'; 

                row.innerHTML = `
                    <td class="px-2 py-3 sm:p-4 table-cell font-bold text-gray-800">${vehicle.model}</td>
                    <td class="px-2 py-3 sm:p-4 table-cell font-mono text-sm text-gray-600">${vehicle.plate}</td>
                    <td class="px-2 py-3 sm:p-4 table-cell text-gray-700">${vehicle.driver}</td>
                    <td class="px-2 py-3 sm:p-4 table-cell text-sm text-gray-500">${vehicle.unit}</td>
                    <td class="px-2 py-3 sm:p-4 table-cell whitespace-nowrap">
                        <span class="inline-block py-1 px-3 text-xs rounded-full ${badgeClasses}">
                            ${formattedDate}
                            ${expiringSoon ? ' (YAKINDA BİTİYOR)' : ''}
                        </span>
                    </td>
                    <td class="px-2 py-3 sm:p-4 table-cell text-right space-x-2 whitespace-nowrap">
                        <button data-id="${vehicle.id}" class="edit-btn text-blue-600 hover:text-white bg-blue-100 hover:bg-blue-500 p-2 rounded-full transition duration-200 shadow-md" title="Aracı Düzenle">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button data-id="${vehicle.id}" class="delete-btn text-red-600 hover:text-white bg-red-100 hover:bg-red-500 p-2 rounded-full transition duration-200 shadow-md" title="Aracı Sil">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                vehicleListBody.appendChild(row);
            });
            
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.currentTarget.dataset.id;
                    if (window.confirm("Bu aracı gerçekten silmek istiyor musunuz? Geri alınamaz bir işlemdir.")) {
                         deleteVehicle(id);
                    }
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.currentTarget.dataset.id;
                    editVehicle(id);
                });
            });
        }
        
        // Araç Güncelleme
        function updateVehicle(id, vehicleData) {
            const index = vehiclesData.findIndex(v => v.id === id);
            
            if (index !== -1) {
                vehiclesData[index] = {
                    ...vehiclesData[index], 
                    ...vehicleData 
                };
                
                saveVehicles();
                filterAndRenderVehicles();
                showNotification(`'${vehicleData.model}' başarıyla güncellendi.`, 'success');
                exitEditMode(); 
                hideForm();
            } else {
                 showNotification("Güncellenecek araç kaydı bulunamadı.", 'error');
            }
        }
        
        // Yerel Depolamaya Tekli Araç Ekleme
        function addVehicle(vehicleData) {
            const newVehicle = {
                ...vehicleData,
                id: Date.now().toString(), 
                createdAt: Date.now() 
            };
        
            vehiclesData.push(newVehicle);
            vehiclesData.sort((a, b) => b.createdAt - a.createdAt); 
            saveVehicles();
            filterAndRenderVehicles();

            showNotification(`'${vehicleData.model}' başarıyla envantere kaydedildi.`, 'success');
            if(vehicleForm) vehicleForm.reset(); 
            hideForm();
        }

        // Yerel Depolamadan Tekli Araç Silme
        function deleteVehicle(id) {
            const initialLength = vehiclesData.length;
            vehiclesData = vehiclesData.filter(vehicle => vehicle.id !== id);
            
            if (vehiclesData.length < initialLength) {
                saveVehicles();
                filterAndRenderVehicles();
                showNotification("Araç başarıyla envanterden silindi.", 'success');
            } else {
                showNotification("Silinecek araç bulunamadı.", 'error');
            }
        }

        // Tablar Arasında Geçiş Fonksiyonu
        function switchTab(target) {
            if (!singleEntryTabBtn || !bulkImportTabBtn || !singleEntryArea || !bulkImportArea) return;

            if (currentEditingId && target === 'bulk') {
                showNotification("Düzenleme modundayken Toplu Ekleme sekmesine geçilemez. Lütfen önce iptal edin.", 'info');
                return;
            }

            const activeClasses = ['border-blue-600', 'text-blue-600'];
            const inactiveClasses = ['border-transparent', 'text-gray-500'];
            const hoverClasses = ['hover:text-blue-600', 'hover:border-blue-300'];

            if (target === 'single') {
                singleEntryArea.classList.remove('hidden');
                bulkImportArea.classList.add('hidden');
                
                singleEntryTabBtn.classList.add(...activeClasses);
                singleEntryTabBtn.classList.remove(...inactiveClasses, ...hoverClasses);
                
                bulkImportTabBtn.classList.remove(...activeClasses);
                bulkImportTabBtn.classList.add(...inactiveClasses, ...hoverClasses);
            } else {
                bulkImportArea.classList.remove('hidden');
                singleEntryArea.classList.add('hidden');

                bulkImportTabBtn.classList.add(...activeClasses);
                bulkImportTabBtn.classList.remove(...inactiveClasses, ...hoverClasses);
                
                singleEntryTabBtn.classList.remove(...activeClasses);
                bulkImportTabBtn.classList.add(...inactiveClasses, ...hoverClasses);
            }
        }
        
        // Formu Gizle Fonksiyonu (ve düzenleme modundan çıkma)
        function hideForm() {
            if (!formSection || !mainLayout || !toggleFormButton || !plusIcon || !minusIcon) return;
            formSection.classList.add('hidden');
            mainLayout.classList.add('has-hidden-form'); 
            toggleFormButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-300');
            toggleFormButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'focus:ring-blue-300');
            plusIcon.classList.remove('hidden');
            minusIcon.classList.add('hidden');
            
            if (currentEditingId) {
                exitEditMode();
            }
        }

        // Formu Göster Fonksiyonu
        function showForm() {
            if (!formSection || !mainLayout || !toggleFormButton || !plusIcon || !minusIcon) return;
            formSection.classList.remove('hidden');
            mainLayout.classList.remove('has-hidden-form');
            toggleFormButton.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'focus:ring-blue-300');
            toggleFormButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-300');
            plusIcon.classList.add('hidden');
            minusIcon.classList.remove('hidden');
        }
        
        // Filtreleme ve Çizme Fonksiyonu
        function filterAndRenderVehicles() {
            if (!searchInput) return;
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderVehicles(vehiclesData); 
                return;
            }

            const filtered = vehiclesData.filter(vehicle => {
                const policyEndString = vehicle.policyEnd || ''; 

                return vehicle.model.toLowerCase().includes(searchTerm) ||
                       vehicle.plate.toLowerCase().includes(searchTerm) ||
                       vehicle.driver.toLowerCase().includes(searchTerm) ||
                       vehicle.unit.toLowerCase().includes(searchTerm) ||
                       policyEndString.toLowerCase().includes(searchTerm); 
            });

            renderVehicles(filtered);
        }

        // ************************************************
        // DÜZELTİLDİ: Toplu İçe Aktarımı Yönetme Fonksiyonu 
        // ************************************************
        async function handleBulkImport() {
            if (!bulkDataInput || !bulkFileInput) return;
            
            if (currentEditingId) {
                showNotification("Lütfen önce düzenleme modundan çıkın.", 'error');
                return;
            }
            
            let rawData = '';

            if (bulkFileInput.files.length > 0) {
                const file = bulkFileInput.files[0];
                if (!file.name.toLowerCase().endsWith('.csv') && file.type !== 'text/csv' && file.type !== 'application/vnd.ms-excel') {
                    showNotification("Lütfen geçerli bir CSV dosyası seçin.", 'error');
                    return;
                }
                
                try {
                    rawData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => resolve(event.target.result);
                        reader.onerror = (error) => reject(error);
                        reader.readAsText(file, 'UTF-8');
                    });
                } catch (e) {
                    showNotification("Dosya okuma sırasında hata oluştu. Lütfen dosya içeriğini yapıştırmayı deneyin.", 'error');
                    return;
                }
            } else {
                rawData = bulkDataInput.value.trim();
            }

            if (!rawData) {
                showNotification("Lütfen içe aktarılacak verileri girin veya bir dosya seçin.", 'error');
                return;
            }

            const lines = rawData.split('\n').filter(line => line.trim() !== '');
            
            // Eğer ilk satır başlık ise (export dosyasından geliyorsa), onu atla
            // Basit bir kontrol: İlk satırda "model" kelimesini ara
            let dataLines = lines;
            if (dataLines.length > 0 && dataLines[0].toLowerCase().includes('model')) {
                dataLines = lines.slice(1);
            }
            
            let successCount = 0;
            let failedCount = 0;
            const errorMessages = [];
            const vehiclesToAdd = [];
            const baseTimestamp = Date.now(); 

            for (let i = 0; i < dataLines.length; i++) {
                const line = dataLines[i];
                // CSV'de tırnak içindeki virgülleri doğru işlemek için regex yerine basit split kullanıldı.
                // Bu, manuel giriş için idealdir. İhraç edilen dosya için ise manuel tırnak temizliği yapılmalıdır.
                // İhracat formatımız tırnaklı olduğu için, veriyi tırnaklardan arındırıp split edelim.
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(p => p.replace(/^"|"$/g, '').trim()); 

                const numFields = parts.length;
                let vehicleData = {};

                // İhracat dosyası formatı (7 alan: model, plate, driver, unit, policyEnd, createdAt, id)
                if (numFields === 7) {
                    const [model, plate, driver, unit, policyEnd, createdAt, id] = parts;
                    vehicleData = { model, plate, driver, unit, policyEnd, createdAt: parseInt(createdAt), id };
                } 
                // Manuel Giriş Formatı (5 alan: Model, Plaka, Sürücü, Birim, Poliçe Bitiş)
                else if (numFields === 5) {
                    const [model, plate, driver, unit, policyEnd] = parts;
                    // Yeni kayıt olduğu için yeni zaman damgaları atıyoruz.
                    vehicleData = { 
                        model, 
                        plate, 
                        driver, 
                        unit, 
                        policyEnd, 
                        id: (baseTimestamp + i).toString(), 
                        createdAt: baseTimestamp + i 
                    };
                } else {
                    failedCount++;
                    errorMessages.push(`Satır ${i + 1} (Önizleme: ${line.substring(0, 20)}...): Eksik/fazla alan. (5 veya 7 bekleniyor, ${numFields} geldi).`);
                    continue;
                }
                
                // Temel doğrulama
                if (!vehicleData.model || !vehicleData.plate || !vehicleData.driver || !vehicleData.unit || !vehicleData.policyEnd) {
                    failedCount++;
                    errorMessages.push(`Satır ${i + 1} (${vehicleData.plate || vehicleData.model}): Tüm temel alanlar doldurulmalıdır.`);
                    continue;
                }

                if (!/^\d{4}-\d{2}-\d{2}$/.test(vehicleData.policyEnd) || isNaN(new Date(vehicleData.policyEnd))) {
                    failedCount++;
                    errorMessages.push(`Satır ${i + 1} (${vehicleData.plate}): Geçersiz Poliçe Bitiş Tarihi formatı (YYYY-MM-DD bekleniyor).`);
                    continue;
                }
                
                vehiclesToAdd.push(vehicleData);
                successCount++;
            }
            
            // Mevcut kayıtlarla çakışmayı önlemek için basit bir kontrol yapılabilir.
            // Şimdilik çakışma kontrolünü atlayıp hepsini ekliyoruz.
            vehiclesData = [...vehiclesData, ...vehiclesToAdd];
            vehiclesData.sort((a, b) => b.createdAt - a.createdAt);
            saveVehicles();
            filterAndRenderVehicles();

            let summaryMessage = `İçe aktarma tamamlandı. ${successCount} araç başarıyla eklendi.`;
            let summaryType = 'success';

            if (failedCount > 0) {
                summaryMessage = `Başarılı: ${successCount} araç eklendi. HATA: ${failedCount} araç eklenemedi. Detayları konsolu kontrol edin (F12).`;
                summaryType = 'error';
                console.error("Toplu İçe Aktarma Detaylı Hataları:", errorMessages);
            }
            
            showNotification(summaryMessage, summaryType);
            
            if (successCount > 0) {
                bulkDataInput.value = ''; 
                bulkFileInput.value = ''; 
            }
            
            hideForm();
        }

        // Form Gönderimini Yönetme (Tekli Giriş / Güncelleme)
        function handleSingleEntrySubmit(e) {
            e.preventDefault();
            
            const model = document.getElementById('model').value.trim();
            const plate = document.getElementById('plate').value.trim();
            const driver = document.getElementById('driver').value.trim();
            const unit = document.getElementById('unit').value.trim();
            const policyEnd = document.getElementById('policyEnd').value.trim(); 

            if (!model || !plate || !driver || !unit || !policyEnd) {
                showNotification("Lütfen tüm alanları doldurun.", 'error');
                return;
            }
            
            if (isNaN(new Date(policyEnd))) {
                showNotification("Geçersiz Poliçe Bitiş Tarihi.", 'error');
                return;
            }

            const vehicleData = { model, plate, driver, unit, policyEnd };
            
            if (currentEditingId) {
                updateVehicle(currentEditingId, vehicleData);
            } else {
                addVehicle(vehicleData);
            }
        }
        
        // Uygulama Başlatma Fonksiyonu
        function initApp() {
            getElements();
            
            // Olay dinleyicilerini ayarla
            if (toggleFormButton) toggleFormButton.addEventListener('click', () => {
                const isHidden = formSection.classList.contains('hidden');
                if (isHidden) { showForm(); } else { hideForm(); }
            });
            if (vehicleForm) vehicleForm.addEventListener('submit', handleSingleEntrySubmit);
            if (singleEntryTabBtn) singleEntryTabBtn.addEventListener('click', () => switchTab('single'));
            if (bulkImportTabBtn) bulkImportTabBtn.addEventListener('click', () => switchTab('bulk'));
            if (bulkImportButton) bulkImportButton.addEventListener('click', handleBulkImport);
            if (searchInput) searchInput.addEventListener('input', filterAndRenderVehicles);
            if (deleteAllButton) deleteAllButton.addEventListener('click', deleteAllVehicles);
            if (cancelButton) cancelButton.addEventListener('click', (e) => { 
                e.preventDefault();
                exitEditMode(); 
                hideForm(); 
                showNotification("Düzenleme iptal edildi.", 'info');
            });
            
            // Export Butonu Olay Dinleyicisi
            if (exportDataButton) {
                exportDataButton.addEventListener('click', () => {
                    const format = prompt("Hangi formatta dışa aktarmak istersiniz? (csv veya json)", "csv");
                    if (format && (format.toLowerCase() === 'csv' || format.toLowerCase() === 'json')) {
                        exportData(format.toLowerCase());
                    } else if (format !== null) {
                        showNotification("Geçersiz format seçimi. Lütfen 'csv' veya 'json' girin.", 'error');
                    }
                });
            }
            
            // Verileri yükle ve görünümü ayarla
            loadVehicles();
            hideForm();
            switchTab('single'); 
        }

        // DOM içeriği yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', initApp);

    </script>

    <header class="mb-4">
    </header>

    <div id="notificationContainer" class="fixed top-4 right-4 z-50 flex flex-col items-end space-y-2">
        </div>

    <main id="mainLayout" class="grid grid-cols-1 gap-8 main-layout">
        
        <section id="formSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 lg:sticky lg-sticky-top h-min transition-all duration-300 ease-in-out">
            <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 text-blue-600">Yeni Araç Kaydı</h2>

            <div class="flex mb-6 border-b border-gray-200">
                <button id="singleEntryTabBtn" class="py-2 px-4 text-sm font-semibold border-b-2 transition duration-150 focus:outline-none">Tekli Giriş</button>
                <button id="bulkImportTabBtn" class="py-2 px-4 text-sm font-semibold border-b-2 transition duration-150 focus:outline-none">Toplu Ekleme</button>
            </div>
            
            <div id="singleEntryArea">
                <form id="vehicleForm" class="space-y-5">
                    
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700 mb-1">Araç Modeli <span class="text-red-500">*</span></label>
                        <input type="text" id="model" name="model" required class="input-focus w-full px-4 py-2 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20" placeholder="Örn: Ford Focus">
                    </div>
                    <div>
                        <label for="plate" class="block text-sm font-medium text-gray-700 mb-1">Plaka <span class="text-red-500">*</span></label>
                        <input type="text" id="plate" name="plate" required class="input-focus w-full px-4 py-2 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20" placeholder="Örn: 34 ABC 123">
                    </div>
                    <div>
                        <label for="driver" class="block text-sm font-medium text-gray-700 mb-1">Kullanan Kişi <span class="text-red-500">*</span></label>
                        <input type="text" id="driver" name="driver" required class="input-focus w-full px-4 py-2 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20" placeholder="Örn: Ali Yılmaz">
                    </div>
                    <div>
                        <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">Birim (Departman) <span class="text-red-500">*</span></label>
                        <input type="text" id="unit" name="unit" required class="input-focus w-full px-4 py-2 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20" placeholder="Örn: Satış, Muhasebe">
                    </div>
                    <div>
                        <label for="policyEnd" class="block text-sm font-medium text-gray-700 mb-1">Poliçe Bitiş Tarihi <span class="text-red-500">*</span></label>
                        <input type="date" id="policyEnd" name="policyEnd" required class="input-focus w-full px-4 py-2 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20">
                    </div>

                    <div class="flex space-x-4 pt-6">
                        <button id="cancelButton" type="button" class="hidden w-1/3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-xl transition duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-gray-300 focus:ring-opacity-50">
                            İptal
                        </button>
                        <button id="submitButton" type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300 focus:ring-opacity-50">
                            Aracı Envantere Kaydet
                        </button>
                    </div>
                </form>
            </div>

            <div id="bulkImportArea" class="hidden">
                <p class="text-sm text-gray-700 mb-4 bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    Verileri **CSV dosyası (.csv)** ile yükleyebilir veya aşağıdaki alana yapıştırabilirsiniz. <br>
                    <span class="font-semibold text-yellow-800">Manuel Giriş (5 Alan): </span> <code class="font-mono text-sm text-red-700">Model, Plaka, Sürücü, Birim, Poliçe Bitiş (YYYY-MM-DD)</code><br>
                    <span class="font-semibold text-yellow-800">Yedek Dosyası (7 Alan): </span> İhraç edilen tüm alanları içerir.
                </p>
                
                <div class="mb-5 p-4 border-2 border-dashed border-gray-300 rounded-xl hover:border-blue-500 transition duration-150">
                    <label for="bulkFileInput" class="block text-sm font-medium text-gray-700 mb-2">CSV Dosyası Yükle (.csv)</label>
                    <input type="file" id="bulkFileInput" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div class="relative mb-4">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center">
                        <span class="px-2 bg-white text-sm text-gray-500">
                            veya Yapıştır
                        </span>
                    </div>
                </div>

                <textarea id="bulkDataInput" rows="5" class="input-focus w-full px-4 py-2 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20 font-mono text-sm resize-none" placeholder="Örn:\nOpel Corsa, 34 XYZ 456, Mehmet Kaya, Muhasebe, 2026-11-15\nVW Passat, 06 ABC 123, Zeynep Demir, Satış, 2025-08-01"></textarea>

                <button id="bulkImportButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-300 focus:ring-opacity-50 mt-4">
                    Toplu İçe Aktarımı Başlat
                </button>
            </div>


        </section>
        
        <section id="listSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <div class="flex items-center space-x-3">
                    <h2 class="text-2xl font-bold text-gray-800 text-indigo-600"></h2> 
                    <div id="totalCountDisplay" class="">
                        </div>
                </div>
                
                <button id="toggleFormButton" title="Yeni Araç Ekle/Formu Gizle" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full transition duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center">
                    <svg id="plusIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <svg id="minusIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                </button>
            </div>
            
            <div class="mb-6">
                <input type="text" id="searchInput" placeholder="Model, plaka, sürücü, birim veya poliçe bitiş tarihine göre ara..." class="input-focus w-full px-4 py-3 border border-gray-300 rounded-xl shadow-inner transition duration-150 focus:ring-4 focus:ring-opacity-20">
            </div>

            <div id="loadingIndicator" class="text-center py-12 text-blue-500 font-semibold text-lg">
                Veriler Yerel Depolamadan Yükleniyor...
            </div>

            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr>
                            <th scope="col" class="px-2 py-3 sm:p-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Model</th>
                            <th scope="col" class="px-2 py-3 sm:p-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Plaka</th>
                            <th scope="col" class="px-2 py-3 sm:p-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Kullanan Kişi</th>
                            <th scope="col" class="px-2 py-3 sm:p-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Birim</th>
                            <th scope="col" class="px-2 py-3 sm:p-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Poliçe Bitiş</th>
                            <th scope="col" class="px-2 py-3 sm:p-4 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Aksiyon</th>
                        </tr>
                    </thead>
                    <tbody id="vehicleListBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <button id="exportDataButton" class="hidden bg-indigo-100 hover:bg-indigo-500 text-indigo-700 hover:text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-300 focus:ring-opacity-50 text-sm flex items-center space-x-2" title="Tüm veriyi yedeklemek için dışa aktarır">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span>Veriyi İndir</span>
                </button>
                
                <button id="deleteAllButton" class="hidden bg-red-100 hover:bg-red-500 text-red-700 hover:text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300 focus:ring-opacity-50 text-sm flex items-center space-x-2" title="Tüm araç kayıtlarını siler">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    <span>Tüm Listeyi Sil</span>
                </button>
            </div>
            
        </section>

    </main>

</body>
</html>
